name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'frontend/mytodo/package-lock.json'

      - name: å®‰è£…åç«¯ä¾èµ–
        working-directory: ./backend/mytodo
        run: mvn dependency:resolve

      - name: æ„å»ºåç«¯
        working-directory: ./backend/mytodo
        run: |
          mvn clean package -DskipTests

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend/mytodo
        run: npm ci

      - name: æ„å»ºå‰ç«¯
        working-directory: ./frontend/mytodo
        run: npm run build

      - name: æ„å»ºDockeré•œåƒ
        run: |
          docker rmi todo-backend:latest
          docker rmi todo-frontend:latest
          docker rmi todo-database:latest
          # æ„å»ºåç«¯é•œåƒ
          docker build -t todo-backend:latest -f backend/Dockerfile backend --load
          
          # æ„å»ºå‰ç«¯é•œåƒ
          docker build -t todo-frontend:latest -f frontend/Dockerfile frontend --load
          
          # æ„å»ºæ•°æ®åº“é•œåƒ
          docker build -t todo-database:latest -f database/Dockerfile database --load

      - name: å¸è½½ç°æœ‰åº”ç”¨
        run: |
          echo "å¸è½½ç°æœ‰Todoåº”ç”¨..."
          
          # åˆ é™¤å‰ç«¯æœåŠ¡
          kubectl delete -f k8s/frontend-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤åç«¯æœåŠ¡
          kubectl delete -f k8s/backend-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤MySQLç›¸å…³èµ„æº
          kubectl delete -f k8s/mysql-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤é…ç½®å’Œå¯†é’¥
          kubectl delete -f k8s/mysql-configmap.yaml --ignore-not-found=true || true
          kubectl delete -f k8s/mysql-secret.yaml --ignore-not-found=true || true
          
          # åˆ é™¤å‘½åç©ºé—´ï¼ˆè¿™ä¼šåˆ é™¤å‘½åç©ºé—´å†…çš„æ‰€æœ‰èµ„æºï¼‰
          kubectl delete namespace todo-app --ignore-not-found=true || true
          
          # ç­‰å¾…å‘½åç©ºé—´åˆ é™¤å®Œæˆ
          kubectl wait --for=delete namespace/todo-app --timeout=300s 2>/dev/null || true
          
          echo "å¸è½½å®Œæˆï¼Œå¼€å§‹é‡æ–°éƒ¨ç½²..."

      - name: éƒ¨ç½²åˆ°Kubernetes
        run: |
          # åˆ›å»ºå‘½åç©ºé—´
          kubectl apply -f k8s/namespace.yaml
          
          # éƒ¨ç½²MySQL
          kubectl apply -f k8s/mysql-secret.yaml
          kubectl apply -f k8s/mysql-configmap.yaml
          kubectl apply -f k8s/mysql-deployment.yaml
          
          # ç­‰å¾…MySQLå°±ç»ª
          kubectl wait --for=condition=ready pod -l app=todo-database -n todo-app --timeout=300s
          
          # éƒ¨ç½²åç«¯
          kubectl apply -f k8s/backend-deployment.yaml
          
          # éƒ¨ç½²å‰ç«¯
          kubectl apply -f k8s/frontend-deployment.yaml
          
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          kubectl wait --for=condition=ready pod -l app=todo-backend -n todo-app --timeout=300s
          kubectl wait --for=condition=ready pod -l app=todo-frontend -n todo-app --timeout=300s

      - name: éªŒè¯éƒ¨ç½²çŠ¶æ€
        run: |
          echo "éƒ¨ç½²å®Œæˆï¼æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š"
          kubectl get all -n todo-app
          
          echo "æŸ¥çœ‹PodçŠ¶æ€ï¼š"
          kubectl get pods -n todo-app
          
          echo "æŸ¥çœ‹æœåŠ¡ç«¯å£ï¼š"
          kubectl get svc -n todo-app

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Todoåº”ç”¨éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:30080"
          echo "ğŸ“Š æŸ¥çœ‹çŠ¶æ€: kubectl get all -n todo-app"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ Todoåº”ç”¨éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: kubectl logs -f deployment/todo-backend -n todo-app"
          echo "ğŸ” æŸ¥çœ‹PodçŠ¶æ€: kubectl describe pods -n todo-app"

    